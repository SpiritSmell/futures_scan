---
trigger: always_on
---

# Coding Conventions

> **Базовый документ:** [vision.md](vision.md)  
> Все технические решения и архитектурные принципы описаны в vision.md. Данный документ содержит только правила написания кода.

## Основной принцип: KISS

Максимальная простота. Никакого оверинжиниринга. Только необходимое для MVP.

## Структура кода

### Организация файлов
- Следовать структуре из раздела 3 vision.md
- Один файл = одна ответственность
- Максимум 2 уровня вложенности папок

### Импорты
- Стандартная библиотека → сторонние библиотеки → локальные модули
- Импорты всегда в начале файла
- Использовать абсолютные импорты

## Стиль кода

### Python
- PEP 8 для форматирования
- Type hints для всех функций и методов
- Docstrings только для публичных API (не для каждой функции)

### Именование
- `snake_case` для функций и переменных
- `PascalCase` для классов
- Явные имена: `exchange_collector` вместо `ec`

## Обработка ошибок

### Принципы из vision.md раздел 2
- **Fail Fast** - явные исключения, не скрывать ошибки
- **Retry логика** - 3 попытки с задержками [1s, 2s, 4s]
- **Изоляция** - ошибка одного сборщика не влияет на другие
- **Логирование** - все ошибки в лог с деталями

### Реализация
```python
# ✅ Правильно
try:
    data = await fetch_data()
except APIError as e:
    logger.error(f"[{exchange}] API error: {e}")
    raise

# ❌ Неправильно
try:
    data = await fetch_data()
except:
    pass  # Молчаливое игнорирование
```

## Асинхронность

### Async/await
- Все I/O операции асинхронные
- Каждая биржа = отдельная async задача
- Использовать `asyncio.gather()` для параллельных операций

### Блокирующие операции
- Не использовать `time.sleep()` → использовать `asyncio.sleep()`
- Не использовать синхронные HTTP клиенты

## Логирование

### Из vision.md раздел 10
- Использовать стандартный `logging` модуль
- Формат: `[LEVEL] [component] message`
- Уровень из конфига
- Logger для каждого компонента: `logger = logging.getLogger(exchange_name)`

### Уровни
- **DEBUG** - детали запросов/ответов
- **INFO** - успешные операции
- **WARNING** - недоступные символы, missing data
- **ERROR** - ошибки API, RabbitMQ

## Конфигурация

### Из vision.md раздел 9
- Все настройки через `config.json`
- API ключи в `.env.keys`
- Валидация через Pydantic
- Никаких hardcoded значений

## Модели данных

### Pydantic
- Все структуры данных через Pydantic BaseModel
- Optional для необязательных полей
- Валидация при создании объекта
- Использовать `model_dump()` для сериализации

### Из vision.md раздел 5
- Следовать структуре FuturesData, TickerData, OrderbookData
- Поле `extra` для расширяемости

## Что НЕ делать

- ❌ Сложные абстракции и паттерны
- ❌ Преждевременная оптимизация
- ❌ Комментарии для очевидного кода
- ❌ Множественные уровни наследования
- ❌ Глобальные переменные
- ❌ Hardcoded значения
- ❌ Игнорирование ошибок

## Зависимости

### Из vision.md раздел 1
- Минимум зависимостей
- Только проверенные библиотеки: ccxt, aio-pika, pydantic
- Указывать версии в requirements.txt

## Тестирование

### Для MVP
- Тесты не пишем на этапе MVP
- Фокус на быстрой проверке идеи
- Папка `tests/` создана для будущего

## Документация

### Минимальная
- README.md с инструкциями по запуску
- Комментарии только для неочевидной логики
- Docstrings для публичных API
- Примеры в config.example.json

## Приоритеты

1. **Работоспособность** - код должен работать
2. **Простота** - легко читать и понимать
3. **Надежность** - обработка ошибок
4. **Расширяемость** - легко добавить биржу/символ

**Производительность и оптимизация - НЕ приоритет для MVP**
